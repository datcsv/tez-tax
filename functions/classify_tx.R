################################################################################
#                                                                              #
# Copyright 2022 datcsv                                                        #
#                                                                              #
# Licensed under the Apache License, Version 2.0 (the "License");              #
# you may not use this file except in compliance with the License.             #
# You may obtain a copy of the License at                                      #
#                                                                              #
#   http://www.apache.org/licenses/LICENSE-2.0                                 #
#                                                                              #  
# Unless required by applicable law or agreed to in writing, software          #
# distributed under the License is distributed on an "AS IS" BASIS,            #
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.     #
# See the License for the specific language governing permissions and          #
# limitations under the License.                                               #
#                                                                              #
################################################################################

# Non-FA2 tokens
nfa2 <- c(
  "KT1G1cCRNBgQ48mVDjopHjEmTN5Sbtar8nn9",
  "KT1Trhji1aVzDtGiAxiCfWNi9T74Kyi49DK1"
)

# HEN contracts
hen_contracts <- c(
  "KT1Hkg5qeNhfwpKW4fXvq7HGZB9z2EnmCCA9", 
  "KT1HbQepzV1nVGg8QVznG7z4RcHseD5kwqBn", 
  "KT1My1wDZHDGweCrJnQJi3wcFaS67iksirvj"
)

# QuipuSwap contracts
quipu_contracts <- c(
  "KT1QxLqukyfohPV5kPkw97Rs6cw1DDDvYgbB",
  "KT1BMEEPX7MWzwwadW3NCSZe9XGmFJ7rs7Dr",
  "KT1X3zxdTzPB9DgVzA3ad6dgZe9JEamoaeRy",
  "KT1FHiJmJUgZMPtv5F8M4ZEa6cb1D9Lf758T",
  "KT1JyPE1BWdYoRGBvvKhEPbcVRd3C9NCCwQC",
  "KT1NEa7CmaLaWgHNi6LkRi5Z1f4oHfdzRdGA",
  "KT1FG63hhFtMEEEtmBSX2vuFmP87t9E7Ab4t",
  "KT1V41fGzkdTJki4d11T1Rp9yPkCmDhB7jph",
  "KT1Qm3urGqkRsWsovGzNb2R81c3dSfxpteHG",
  "KT1U2hs5eNdeCpHouAvQXGMzGFGJowbhjqmo",
  "KT1X6dAh8fwQMkWC9yh4yuvkJaS5NjqY4NvW",
  "KT1NXdxJkCiPkhwPvaT9CytFowuUoNcwGM1p",
  "KT1JzZtBeHDBS9XyEqUc9nZhsqcfeNLxVV1T",
  "KT1X6MJFtzypK6yuMXzg4KQ9FJAccH8PazKz",
  "KT1C755xS3TLH4HEWaCJvWuoHTcytTBdEjgS",
  "KT1Ji39TrkVBd6L2SL7H4u9yvA1sPuSygthq",
  "KT1K4EwTpbvYN9agJdjpyJm4ZZdhpUNKB3F6",
  "KT1R8eiRrSoSHufHXPqevZZYEUVzBxhcdenP",
  "KT1XmsFAdPhsDnhGzQLqQQiGkCGoyekGFC8B",
  "KT1ULad9tYBY39FT8K1Dgtha7jD3qpygbLPG",
  "KT1LZqFas2GEUe5z5CFkL9Wqq6tZFzQbopm8",
  "KT1Gdix8LoDoQng7YqdPNhdP5V7JRX8FqWvM",
  "KT1WREc3cpr36Nqjvegr6WSPgQKwDjL7XxLN",
  "KT1VEKgCCYCudjfvLZaEh4havFiJMmxMgNdX",
  "KT1Eg2QesN1tCzScTrvoeKm5W67GgjV32McR",
  "KT1Vjp7tHoNXRPpd9BbGrq9pbxF1FxMFUFTE",
  "KT1GFDagtGGQS1gmC3S6Noqns1svCTzL23By",
  "KT1DksKXvCBJN7Mw6frGj6y6F3CbABWZVpj1",
  "KT1ANY7962FTf2RqJMMF4paZkuTQA77994yv",
  "KT1RRgK6eXvCWCiEGWhRZCSVGzhDzwXEEjS4",
  "KT1ANEFHasacTTZxGPmQmZo7spj5YuLE6TL4",
  "KT1X1LgNkQShpF9nRLYw3Dgdy4qp38MX617z",
  "KT1A91CcMx1izXcbBwyH3z8Do3vnEdKpbde2",
  "KT1BgezWwHBxA9NrczwK9x3zfgFnUkc7JJ4b",
  "KT1Evsp2yA19Whm24khvFPcwimK6UaAJu8Zo",
  "KT1DuYujxrmgepwSDHtADthhKBje9BosUs1w"
)

# Tezos Domains contracts
td_contracts <- c(
  "KT1P8n2qzJjwMPbHJfi4o8xu6Pe3gaU3u2A3",
  "KT191reDVKrLxU9rjTSxg53wRqj6zh8pnHgr",
  "KT1Mqx5meQbhufngJnUAGEGpa4ZRxhPSiCgB",
  "KT1GBZmSxmnKJXGMdMLbugPfLyUPmuLSMwKS",
  "KT1Evxe1udtPDGWrkiRsEN3vMDdB6gNpkMPM",
  "KT1EVYBj3f1rZHNeUtq4ZvVxPTs77wuHwARU"
)

# OBJKT contracts
objkt_contracts <- c(
  "KT1Dno3sQZwR5wUCWxzaohwuJwG3gX1VWj1Z",
  "KT1FvqJwEDWb1Gwc55Jd1jjTHRVWbYKUUpyq",
  "KT1XjcRq5MLAzMKQ3UHsrue2SeU2NbxUrzmU",
  "KT1HZVd9Cjc2CMe3sQvXgbxhpJkdena21pih",
  "KT1QJ71jypKGgyTNtXjkCAYJZNhCKWiHuT2r",
  "KT1Aq4wWmVanpQhq4TTfjZXB5AjFpx15iQMM"
  #"KT1Wvk8fon9SgNEPQKewoSL2ziGGuCQebqZc"
)

# akaSwap contracts
aka_contracts <- c(
  "KT1HGL8vx7DP4xETVikL4LUYvFxSV19DxdFN",
  "KT1NL8H5GTAWrVNbQUxxDzagRAURsdeV3Asz",
  "KT1ULea6kxqiYe1A7CZVfMuGmTx7NmDGAph1",
  "KT19QcybJCf8zKCEECRhtMUYTptTwgY9jMKU"
)

# fxhash contracts
fx_contracts <- c(
  "KT1AEVuykWeuuFX7QkEAMNtffzwhe1Z98hJS",
  "KT1XCoGnfupWk7Sp8536EfrxcP73LmT68Nyr",
  "KT1Xo5B7PNBAeynZPmca4bRh6LQow4og1Zb9",
  "KT1Ezht4PDKZri7aVppVGT4Jkw39sesaFnww" 
)

# Rarible contracts
rari_contracts <- c(
  "KT198mqFKkiWerXLmMCw69YB1i6yzYtmGVrC",
  "KT18pVpRXKPY2c4U2yFEGSH3ZnhB2kL8kwXS"
)

wrap_contracts <- c(
  "KT1DLif2x9BtK6pUq9ZfFVVyW5wN2kau9rkW",
  "KT1MTnKjFSN2u4myPRBqnFuCYCPX8kTdUEnv"
)

# Create null income statement
is <- operations[0, ]

# Identify unique operation groups
operations_hash <- operations %>% distinct(., hash)

# Adjust operation data
operations %<>% mutate(., bidKey = "")

# Iterate over unique operation groups to build income statement
for (i in 1:nrow(operations_hash)) {
  
  ##############################################################################
  # Define variables, as necessary
  ##############################################################################
  
  # Helper variables, hash adjustment, etc
  x <- operations %>% 
    filter(., hash == operations_hash[[1]][i]) %>%
    mutate(., hash = str_split(hash, "_", simplify=TRUE)[, 1])
  y <- x
  
  # Update token data
  if (sum(c("transfer", "mint") %in% x$parameterEntry) > 0) {
    for (i in 1:nrow(x)) {
      
      # Add token metadata, if possible
      if (sum(c("transfer", "mint") %in% x$parameterEntry[i]) > 0) {
        x$tokenID[i]       <- paste0(x$targetAddress[i], "_", list_check(x$parameterValue[i], c("token_id", "itokenid")))
        x$tokenSender[i]   <- list_check(x$parameterValue[i], c("address", "from_", "from"))
        x$tokenReceiver[i] <- list_check(x$parameterValue[i], c("to_", "to"))
        x$tokenAmount[i]   <- as.numeric(list_check(x$parameterValue[i], "amount", "value"))
      }
    }
  }
  x$xtzSent     <- max(x$xtzSent, na.rm=TRUE)
  x$xtzReceived <- sum(x$xtzReceived)
  xtzCollect    <- sort(x$xtzAmount, decreasing=TRUE)[2]
  
  ##############################################################################
  # Identify operation groups, filter and classify as necessary
  ##############################################################################
  
  # Adjust reveals
  if (("reveal" %in% x$type) & (nrow(x) > 1)) {
    x %<>% filter(., type != "reveal")
  }
  
  # Failed transaction
  if (sum(c("failed", "backtracked") %in% x$status) > 0) {
    x %<>% quick_case(., case="Failed transaction", type=2)
    x %<>% mutate(., tokenAmount=0)
  }
  
  # Adjust delegation operations
  else if ("delegation" %in% x$type) {
    x %<>% quick_case(., case="Delegation", type=2) 
  }
  
  # Adjust other non-transactionary operations
  else if (!("transaction" %in% x$type)) {
    x %<>% quick_case(., case="Non-transaction", type=2)
  }
  
  # Standard transaction
  else if (sum(is.na(x$parameterEntry)) == nrow(x)) {
    x %<>%
      filter(., (SenderAddress %in% wallets) | (targetAddress %in% wallets)) %>%
      mutate(., case = "Standard transaction")
    
    # Adjust wallet-to-wallet transfers
    if (
      (sum(x$SenderAddress %in% wallets) > 0) & 
      (sum(x$targetAddress %in% wallets) > 0)
    ) {
      x %<>% mutate(., xtzSent=xtzFee, xtzReceived=0, case="Wallet transfer")
    }
    
  }
  
  # Token transfer
  else if ((nrow(x) == 1) & ("transfer" %in% x$parameterEntry)) {
    x %<>% mutate(., tokenSender=SenderAddress, case="Token transfer")
    
    # Adjust wallet-to-wallet transfers
    if ((x$tokenSender %in% wallets) & (x$tokenReceiver %in% wallets)) {
      x %<>% mutate(., tokenAmount=0, case="Wallet transfer")
    }
    
  }
  
  # Contract signature
  else if ((nrow(x) == 1) & ("sign" %in% x$parameterEntry)) {
    x %<>% mutate(., case="Contract signature")
  }
  
  # HEN contracts
  else if (sum(hen_contracts %in% x$targetAddress) > 0) {
    
    # HEN mint
    if ("mint" %in% x$parameterEntry) {
      x %<>% 
        filter(., parameterEntry == "mint") %>% 
        mutate(., tokenSender=NA, tokenReceiver=initiatorAddress, case="HEN mint")
    }
    
    # HEN swap
    else if ("swap" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="swap", case="HEN swap")
    }
    
    # HEN cancel swap
    else if ("cancel_swap" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="cancel_swap", case="HEN cancel swap")
    }
    
    # HEN trade
    else if (
      ("collect" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) == 0)
    ) {
      
      # Do not classify batch trades
      n_collect <- sum(x$parameterEntry == "collect", na.rm=TRUE)
      if (n_collect == 1) {
        token_sender <- x$targetAddress[which(x$targetAddress %in% wallets)][1]
        x %<>%
          filter(., parameterEntry == "transfer") %>%
          mutate(.,
            tokenAmount=ifelse(xtzCollect > xtzReceived, 0, tokenAmount),
            tokenSender=ifelse(xtzCollect <= xtzReceived, token_sender, NA),
            case=ifelse(
              xtzCollect > xtzReceived,
              "HEN collect (royalties)",
              "HEN collect (trade)"
            )
          )
      }
      else {
        x <- y
      }
    }
    
    # HEN collect
    else if (
      ("collect" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) > 0)
    ) {
      x %<>% quick_case(., entry="transfer", case="HEN collect")
    }
    
    # HEN curate
    else if ("curate" %in% x$parameterEntry) {
      x %<>% 
        quick_case(., case="HEN curate", type=2) %>%
        mutate(., 
          tokenID="KT1AFA2mwNUMNd4SsujE1YYp29vd8BZejyKW_0",
          tokenAmount=as.numeric(list_check(parameterValue, "hDAO_amount")),
          tokenSender=initiatorAddress
        )
    }
    
    # HEN registry
    else if ("registry" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="registry", case="HEN registry")
    }
    
    # HEN unidentified
    else {
      x <- y
    }
  }
  
  # QuipuSwap contracts
  else if (sum(quipu_contracts %in% x$targetAddress) > 0) {
    
    # Drop extra approval data
    if (("approve" %in% x$parameterEntry) & (nrow(x) > 1)) {
      x %<>% mutate(., xtzSent = xtzSent - xtzFee / 2)
    }
    
    # QuipuSwap trade
    if (sum(c("tezToTokenPayment", "tokenToTezPayment") %in% x$parameterEntry) > 0) {
      x %<>% 
        quick_case(., entry="transfer", case="QuipuSwap trade") %>%
        mutate(., tokenAmount = as.numeric(list_check(parameterValue, c("value", "amount"))))
    }
    
    # Quipuswap unidentified
    else {
      x <- y
    }
  }
  
  # Tezos Domains contracts
  else if (sum(td_contracts %in% x$targetAddress) > 0) {
    
    # TD commit
    if ("commit" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="commit", case="TD commit")
    }
    
    # TD buy
    else if ("buy" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="buy", case="TD buy")
    }
    
    # TD update record
    else if ("update_record" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="update_record", case="TD update record")
    }
    
    # TD update reverse record
    else if ("update_reverse_record" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="update_reverse_record", case="TD update reverse record")
    } 
    
    # TD place offer
    else if ("place_offer" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="place_offer", case="TD place offer")
    }
    
    # TD renew
    else if ("renew" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="renew", case="TD renew")
    }
    
    # TD unidentified
    else {
      x<- y
    }
  }
  
  # OBJKT contracts
  else if (sum(objkt_contracts %in% x$targetAddress) > 0) {
    
    # OBJKT ask
    if ("ask" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="ask", case="OBJKT ask")
    }
    
    # OBJKT retract ask
    else if ("retract_ask" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="retract_ask", case="OBJKT retract ask")
    }
    
    # OBJKT retract bid
    else if ("retract_bid" %in% x$parameterEntry) {
      x %<>% 
        top_n(., n=-1, wt=id) %>%
        mutate(., 
          tokenAmount   = 0, 
          xtzSent       = xtzSent / 2,
          xtzFee        = xtzFee / 2,
          case          = "OBJKT retract bid"
        )
      
      # Check if bid recorded, zero out if so
      tx_id         <- x$id[1]
      tx_hash       <- x$hash[1]
      tx_operations <- tzkt_operations_hash(tx_hash, quote=currency)
      tx_operations %<>% filter(., type == "transaction")
      id  <- tx_operations$diffs[[1]]$bigmap
      key <- tx_operations$diffs[[1]]$content$hash
      
      if ((!is.na(key)) & (key %in% is$bidKey)) {
        is %<>% mutate(.,
          tokenAmount = ifelse(bidKey == key & case != "OBJKT win auction (6210)", 0, tokenAmount), 
          xtzSent = ifelse(bidKey == key & case != "OBJKT win auction (6210)", 0, xtzSent),
          case    = ifelse(bidKey == key & case != "OBJKT win auction (6210)", "OBJKT bid retract", case)
        )
      }
    }
    
    # OBJKT bid
    else if ("bid" %in% x$parameterEntry) {
      x %<>% 
        top_n(., n=-1, wt=id) %>%
        mutate(., 
          xtzReceived=ifelse(SenderAddress %in% wallets, 0, 0),
          xtzSent=ifelse(SenderAddress %in% wallets, xtzSent - xtzAmount, 0),
          case=ifelse(SenderAddress %in% wallets, "OBJKT bid", "OBJKT outbid")
        )
      
      # Check if auction was won
      tx_id         <- x$id[1]
      tx_hash       <- x$hash[1]
      tx_operations <- tzkt_operations_hash(tx_hash, quote=currency)
      tx_operations %<>% filter(., id == tx_id)
      id  <- tx_operations$diffs[[1]]$bigmap
      key <- tx_operations$diffs[[1]]$content$key
      bigmap <- tzkt_bigmap(id=id, key=key)
      
      # Omit early OBJKT contracts
      if (x$targetAddress[1] != "KT1Dno3sQZwR5wUCWxzaohwuJwG3gX1VWj1Z") {
        
        if (id == 6210) {
          state    <- as.numeric(bigmap$value$state)
          price    <- as.numeric(bigmap$value$current_price) / 1000000
          buyer    <- bigmap$value$highest_bidder
          time     <- bigmap$value$end_time
          token_id <- paste0(bigmap$value$fa2, "_", bigmap$value$objkt_id)
          bidHash  <- NA
          bidCase  <- "OBJKT win auction (6210)"
        }
        else if (id == 5910) {
          state    <- ifelse(bigmap$active == "FALSE", 2, 1)
          price    <- as.numeric(bigmap$value$xtz_per_objkt) / 1000000
          buyer    <- bigmap$value$issuer
          time     <- tzkt_block(bigmap$lastLevel)$timestamp
          token_id <- paste0(bigmap$value$fa2, "_", bigmap$value$objkt_id)
          bidHash  <- tx_operations$diffs[[1]]$content$hash
          bidCase  <- "OBJKT win auction (5910)"
        }
        else {
          warning(cat("\nOBJKT auction contract not recognized:", tx_hash))
          state <- NA
        }
        
        if (
          (state == 2) &
          (as.Date(time) >= as.Date(date_span[1])) &
          (as.Date(time) <= as.Date(date_span[2])) &
          (buyer %in% wallets) &
          (price == x$xtzAmount[[1]])
        ) {
          x2 <- mutate(x,
            timestamp    = time,
            quote        = tx_operations$quote[[1]],
            xtzSent      = price,
            xtzReceived  = 0,
            tokenID      = token_id,
            tokenAmount  = 1,
            tokenReceiver= buyer,
            case         = bidCase,
            bidKey       = bidHash
          )
          x %<>% bind_rows(., x2)
        }
      }
    }
    
    # OBJKT win auction (old contract)
    else if (
      ("swap" %in% x$parameterEntry) & 
      ("KT1Dno3sQZwR5wUCWxzaohwuJwG3gX1VWj1Z" %in% x$targetAddress)
    ) {
      x %<>% quick_case(., entry="transfer", case="OBJKT win auction (old)")
      tx_hash <- x$hash[1]
      tx_operations <- tzkt_operations_hash(tx_hash, quote=currency)
      tx_operations %<>% filter(., tx_operations$parameter$entrypoint == "swap")
      price <- as.numeric(tx_operations$diffs[[1]]$content$value$xtz_per_objkt) / 1000000
      x %<>% mutate(., xtzSent=price)
    }
    
    # OBJKT fulfill ask (trade)
    else if (
      ("fulfill_ask" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) == 0)
    ) {
      token_sender <- x$targetAddress[which(x$targetAddress %in% wallets)][1]
      x %<>% 
        filter(., parameterEntry == "transfer") %>% 
        mutate(., 
        tokenAmount=ifelse(xtzCollect > xtzReceived, 0, tokenAmount),
        tokenSender=ifelse(xtzCollect <= xtzReceived, token_sender, NA),
        case=ifelse(
            xtzCollect > xtzReceived, 
            "OBJKT fulfill ask (royalties)", 
            "OBJKT fulfill ask (trade)"
          )
        )
    }
    
    # OBJKT fulfill ask (collect)
    else if (
      ("fulfill_ask" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) > 0)
    ) {
      x %<>% quick_case(., entry="transfer", case="OBJKT fulfill ask (collect)")
    }
    
    # OBJKT fulfill bid (trade)
    else if (
      ("fulfill_bid" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) > 0)
    ) {
      
      # Adjust for batch trades
      x <- x[-c(1, nrow(x)), ]
      collectN <- sum(x$parameterEntry == "fulfill_bid", na.rm=TRUE)
      entries <- (nrow(x) / collectN)
      
      for (i in 1:collectN) {
        x2 <- x[(1 + (i - 1) * entries):(i * entries), ]
        token_sender <- x2$targetAddress[which(x2$targetAddress %in% wallets)][1]
        
        x2 %<>% mutate(., xtzReceived = ifelse(targetAddress %in% wallets, xtzAmount, 0))
        x2$xtzReceived <- sum(x2$xtzReceived)
        
        x2 %<>% 
          filter(., parameterEntry == "transfer") %>% 
          mutate(., 
            tokenAmount=ifelse(xtzCollect > xtzReceived, 0, tokenAmount),
            tokenSender=ifelse(xtzCollect <= xtzReceived, token_sender, NA),
            xtzSent=xtzFee / collectN,
            case=ifelse(
              xtzCollect > xtzReceived,
              "OBJKT fulfill bid (royalties)",
              "OBJKT fulfill bid (trade)"
            )
          )
        
        if (i == 1) x3 <- x2
        else x3 %<>% bind_rows(., x2)
      }
      x <- x3
      
    }
    
    # OBJKT fulfill bid (collect)
    else if (
      ("fulfill_bid" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) == 0)
    ) {
      x %<>% quick_case(., entry="transfer", case="OBJKT fulfill bid (collect)")
    }
    
    # OBJKT buy dutch auction
    else if (
      ("buy" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) > 0)
    ) {
      x %<>% quick_case(., entry="transfer", case="OBJKT buy dutch auction")
    }
    
    # OBJKT create auction
    else if("create_auction" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="create_auction", case="OBJKT create auction")
    }
    
    # OBJKT conclude auction
    else if("conclude_auction" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="conclude_auction", case="OBJKT conclude auction") 
    }
    
    # OBJKT cancel auction
    else if("cancel_auction" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="cancel_auction", case="OBJKT cancel auction")
    }
    
    # OBJKT create collection
    else if ("create_artist_collection" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="create_artist_collection", case="OBJKT create collection")
    } 
    
    # OBJKT mint
    else if ("mint_artist" %in% x$parameterEntry) {
      x %<>%
        filter(., parameterEntry == "mint") %>%
        mutate(., 
          tokenSender=NA,
          tokenReceiver=initiatorAddress, 
          case="OBJKT mint"
        )
    }
    
    # OBJKT update metadata
    else if ("update_artist_metadata" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="update_artist_metadata", case="OBJKT update metadata")
    }
    
    # OBJKT unidentified
    else {
      x <- y
    }
  }
  
  # akaSwap contracts
  else if (sum(aka_contracts %in% x$targetAddress) > 0) {
    
    # akaSwap mint
    if ("mint" %in% x$parameterEntry) {
      x %<>% 
        filter(., parameterEntry == "mint") %>% 
        mutate(., tokenSender=NA, tokenReceiver=initiatorAddress, case="akaSwap mint")
    }
    
    # akaSwap trade
    else if (
      ("collect" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) == 0)
    ) {
      token_sender <- x$targetAddress[which(x$targetAddress %in% wallets)][1]
      x %<>% 
        top_n(., n=1, wt=id) %>%
        mutate(., 
          tokenAmount=ifelse(
            xtzCollect <= xtzReceived, 
            as.numeric(list_check(parameterValue, "amount")), 0
          ),
          tokenSender=ifelse(xtzCollect <= xtzReceived, token_sender, NA),
          case=ifelse(xtzCollect <= xtzReceived, "akaSwap trade", "akaSwap royalties")
        )
    }
    
    # akaSwap collect
    else if (
      ("collect" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) > 0)
    ) {
      x %<>% quick_case(., case="akaSwap collect", type=2)
    }
    
    # akaSwap collect bundle
    else if (
      ("collect_bundle" %in% x$parameterEntry) &
      (sum(wallets %in% x$initiatorAddress) > 0)
    ) {
      x %<>% quick_case(., case="akaSwap collect bundle", type=2)
      x_params <- x$parameterValue[[1]][[1]][[1]]
      x_n <- nrow(x_params)
      y <- x
      x <- x[0, ]
      for (i in 1:x_n) {
        x_i <- y
        x_i$tokenReceiver <- x_params$to_[[i]]
        x_i$tokenAmount <- as.numeric(x_params$amount[[i]])
        x_i$tokenID <- paste0(x_i$targetAddress, "_", x_params$token_id[[i]])
        x_i$xtzSent <- x_i$xtzSent / x_n
        x %<>% bind_rows(., x_i)
      }
    }
    
    # akaSwap swap
    else if ("swap" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="swap", case="akaSwap swap")
    }
    
    # akaSwap cancel swap
    else if ("cancel_swap" %in% x$parameterEntry) {
      x %<>%  quick_case(., entry="cancel_swap", case="akaSwap cancel swap")
    }
    
    # akaSwap gachapon royalties
    else if (
      ("default" %in% x$parameterEntry) &
      (sum(wallets %in% x$initiatorAddress) == 0)
    ) {
      target_address <- x$targetAddress[which(x$targetAddress %in% wallets)][1]
      x %<>% 
        filter(., targetAddress == target_address) %>%
        mutate(., case="akaSwap gachapon royalties")
    }
    
    # akaSwap unidentified
    else {
      x <- y
    }
  }
  
  # Tezzardz mint
  else if (
    ("KT1LHHLso8zQWQWg1HUukajdxxbkGfNoHjh6" %in% x$targetAddress) & 
    ("mint" %in% x$parameterEntry)
  ) {
    tz <- as.numeric(x$parameterValue[[1]])
    x %<>%
      filter(., 
        parameterEntry == "mint",
        !row_number() == 1
      ) %>% 
      mutate(., 
        xtzSent=xtzSent / tz,
        tokenSender=targetAddress,
        tokenReceiver=list_check(parameterValue, "address"),
        case="Tezzardz mint"
      )
  }
  
  # Gogos mint
  else if (
    ("KT1CExkW5WoKqoiv5An6uaZzN6i2Q3mxcqpW" %in% x$targetAddress) & 
    ("mint" %in% x$parameterEntry)
  ) {
    tz <- as.numeric(x$parameterValue[[1]])
    x %<>%
      filter(., 
        parameterEntry == "mint",
        !row_number() == 1
      ) %>% 
      mutate(., 
        xtzSent=xtzSent / tz,
        tokenSender=targetAddress,
        tokenReceiver=list_check(parameterValue, "address"),
        case="Gogos mint"
      )
  }
  
  # Neonz mint
  else if (
    ("KT1QMAN7pWrR7fdiiMZ8mtVMMeFw2nADcVAH" %in% x$targetAddress) & 
    ("mint" %in% x$parameterEntry)
  ) {
    tz <- as.numeric(x$parameterValue[[1]])
    x %<>%
      filter(., 
        parameterEntry == "mint", 
        !row_number() == 1
      ) %>% 
      mutate(., 
        xtzSent=xtzSent / tz,
        tokenSender=targetAddress,
        tokenReceiver=list_check(parameterValue, "address"),
        case="Neonz mint"
      )
  }
  
  # Ziggurats mint
  else if (
    ("KT1NC4pPLbhcw5JRq89NnHgwXg9uGztSZm1k" %in% x$targetAddress) & 
    ("mint" %in% x$parameterEntry)
  ) {
    tz <- as.numeric(x$parameterValue[[1]])
    x %<>%
      filter(., 
        parameterEntry == "mint", 
        !row_number() == 1
      ) %>% 
      mutate(., 
        xtzSent=xtzSent / tz,
        tokenSender=targetAddress,
        tokenReceiver=list_check(parameterValue, "address"),
        case="Ziggurats mint"
      )
  }
  
  # Hash Three Points mint
  else if (
    ("KT1Fxz4V3LaUcVFpvF8pAAx8G3Z4H7p7hhDg" %in% x$targetAddress) & 
    ("mint" %in% x$parameterEntry)
  ) {
    x %<>% quick_case(., entry="mint", case="H3P mint")
    token_id <- as.numeric(tzkt_operations_hash(x$hash[1])$storage$next_id) - 1
    token_id <- paste0(x$targetAddress[1], "_", token_id)
    x$tokenID <- token_id
  }

  # Randomly Common Skeles mint
  else if (
    ("KT1AvxTNETj3U4b3wKYxkX6CKya1EgLZezv8" %in% x$targetAddress) &
    ("buy" %in% x$parameterEntry)
  ){
    x %<>% quick_case(., entry="buy", case="RCS mint")
    
    # RCS mint assumption logic
    if (rcs_mint) {
      x %<>% 
        mutate(., 
          tokenID       = "KT1HZVd9Cjc2CMe3sQvXgbxhpJkdena21pih_0",
          tokenReceiver = SenderAddress,
          tokenAmount   = round((xtzSent - xtzFee) / 5.00, 0)
        )
    }
    
  }
  
  # Pixel Potus contracts
  else if ("KT1WGDVRnff4rmGzJUbdCRAJBmYt12BrPzdD" %in% x$targetAddress) {
    
    # Pixel Potus claim
    if ("claim" %in% x$parameterEntry) {
      claim_paid <- sum(filter(x, parameterEntry == "claim_paid")$xtzAmount)
      x %<>% 
        quick_case(., entry="claim", case="Pixel Potus claim") %>%
        mutate(., xtzSent = claim_paid + xtzFee)
    }
    
    # Pixel Potus trade
    else if ("take_trade" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="transfer", case="Pixel Potus trade")
    }
    
    # Pixel Potus unidentified
    else {
      x <- y
    }
  }
  
  # fxhash contracts
  else if (sum(fx_contracts %in% x$targetAddress) > 0) {
    
    # fxhash issue mint
    if ("mint_issuer" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="mint_issuer", case="fxhash mint issue")
    }
    
    # fxhash mint
    else if ("mint" %in% x$parameterEntry) {
      x %<>%
        filter(., parameterEntry == "mint", !row_number() == 1) %>%
        mutate(., 
          case="fxhash mint", 
          tokenAmount=1
        )
      
      if (x$tokenSender %in% wallets) {
        x %<>% mutate(., 
          case="fxhash self-mint",
          tokenReceiver=tokenSender,
          tokenSender=NA
        )
      }
      
    }
    
    # fxhash offer
    else if ("offer" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="offer", case="fxhash offer")
      x <- x[1, ]
    }
    
    # fxhash cancel offer
    else if ("cancel_offer" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="cancel_offer", case="fxhash cancel offer")
      x <- x[1, ]
    }
    
    # fxhash trade
    else if (
      ("collect" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) == 0)
    ) {
      x %<>% 
        filter(., parameterEntry == "transfer") %>%
        mutate(., 
          tokenAmount=ifelse(
            xtzCollect <= xtzReceived, 
            as.numeric(list_check(parameterValue, "amount")), 0),
          tokenSender=ifelse(xtzCollect <= xtzReceived, wallets[1], NA),
          case=ifelse(xtzCollect <= xtzReceived, "fxhash trade", "fxhash royalties")
        )
    }
    
    # fxhash collect
    else if (
      ("collect" %in% x$parameterEntry) & 
      (sum(wallets %in% x$initiatorAddress) > 0)
    ) {
      x %<>% quick_case(., entry="transfer", case="fxhash collect")
    }
    
    # fxhash update profile
    else if ("update_profile" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="update_profile", case="fxhash update profile")
    }
    
    # fxhash unidentified
    else {
      x <- y
    }
  }
  
  # Rarible contracts
  else if (sum(rari_contracts %in% x$targetAddress) > 0) {
    
    # Rarible collect
    if (
      ("match_orders" %in% x$parameterEntry) &
      (sum(wallets %in% x$initiatorAddress) > 0)
    ) {
      x %<>% quick_case(., entry="transfer", case="Rarible collect")
    }
    
    # Rarible trade
    else if (
      ("match_orders" %in% x$parameterEntry) &
      (sum(wallets %in% x$initiatorAddress) == 0)
    ) {
      xtzCollect <- sort(x$xtzAmount, decreasing=TRUE)[5]
      x %<>% 
        quick_case(., entry="transfer", case="Rarible trade") %>%
        mutate(.,
          tokenAmount=ifelse(xtzCollect > xtzReceived, 0, tokenAmount),
          tokenSender=ifelse(xtzCollect <= xtzReceived, token_sender, NA),
          case=ifelse(
            xtzCollect > xtzReceived,
            "Rarible collect (royalties)",
            "Rarible collect (trade)"
          )
        )
    }
    
    # Rarible mint
    else if ("mint" %in% x$parameterEntry) {
      x %<>% mutate(., case="Rarible mint")
    }
    
    # Rarible update operators
    else if ("update_operators_for_all" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="update_operators_for_all", case="Rarible update operators")
    }
    
    # Rarible cancel
    else if ("cancel" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="cancel", case="Rarible cancel")
    }
    
    # Rarible unidentified
    else {
      x <- y
    }
  }
  
  # Goren tokens
  else if ("KT1JBThDEqyqrEHimhxoUBCSnsKAqFcuHMkP" %in% x$targetAddress) {
    
    # Goren mint
    if ("mint" %in% x$parameterEntry) {
      x %<>% 
        filter(., parameterEntry == "mint") %>%
        mutate(., 
          tokenReceiver = SenderAddress,
          tokenAmount   = 1,
          case = "Goren mint"
        )
    }
    
    # Goren update
    else if ("update_operators" %in% x$parameterEntry) {
      x %<>% quick_case(., entry="update_operators", case="Goren update")
    }
    
    # Goren sell
    else if ("sell" %in% x$parameterEntry) {
      x %<>% 
        filter(., parameterEntry == "transfer") %>%
        mutate(., case = "Goren sell")
    }

    # Goren unidentified
    else {
      x <- y
    }
  }
  
  # WRAP tokens
  else if (sum(wrap_contracts %in% x$targetAddress) > 0) {
    
    # WRAP mint
    if ("minter" %in% x$parameterEntry) {
      x %<>% 
        filter(., parameterEntry == "mint_tokens") %>%
        mutate(., 
          tokenReceiver = initiatorAddress,
          case          = "WRAP mint"
        )
      parameter_value <- filter(x[1, ]$parameterValue[[1]], owner %in% wallets)
      token_id <- str_c(x[1,]$targetAddress, "_", parameter_value[1, ]$token_id)
      token_amount <- parameter_value[1, ]$amount
      x %<>% 
        mutate(.,
          tokenID = token_id, 
          tokenAmount = as.numeric(token_amount)
        )
    }
    
    # WRAP unwrap
    else if ("unwrap_erc20" %in% x$parameterEntry) {
      x %<>% 
        filter(., parameterEntry == "burn_tokens") %>%
        mutate(., 
          tokenSender = initiatorAddress,
          case        = "WRAP unwrap"
        )
      parameter_value <- filter(x[1, ]$parameterValue[[1]], owner %in% wallets)
      token_id <- str_c(x[1,]$targetAddress, "_", parameter_value[1, ]$token_id)
      token_amount <- parameter_value[1, ]$amount
      x %<>% 
        mutate(., 
          tokenID = token_id, 
          tokenAmount = as.numeric(token_amount)
        )
    }
    
    # WRAP unidentified
    else {
      x <- y
    }
  }
  
  # Unidentified
  else {
    x <- y
  }
  
  # Check for hDAO airdrop
  if ("hDAO_batch" %in% y$parameterEntry) {
    x_h         <- filter(y, parameterEntry == "hDAO_batch")
    y2 <-filter(y, type == "transaction")
    x_h_wallets <- y2$parameterValue[[5]][[1]]
    x_h_amount  <- as.numeric(y2$parameterValue[[5]][[2]])
    x_h_index   <- which(x_h_wallets %in% wallets)
    if (length(x_h_index) > 0) {
      x_h %<>% 
        mutate(.,
          xtzSent       = 0,
          xtzReceived   = 0,
          tokenID       = "KT1AFA2mwNUMNd4SsujE1YYp29vd8BZejyKW_0",
          tokenReceiver = x_h_wallets[x_h_index][1],
          tokenAmount   = sum(x_h_amount[x_h_index]),
          case          = "hDAO airdrop"
        )
        if (sum(c("failed", "backtracked") %in% x$status) > 0) {
          x_h %<>% mutate(., tokenAmount=0, case="Failed transaction")
        }
      x %<>% add_row(., x_h)
    }
  }
  
  # Add row(s) to income statement
  is %<>% bind_rows(., x)  
}

# Adjust income statement data
is %<>% select(., -bidKey)
